---
title: 缓存更新策略
date: 2023-09-07 17:59:14
categories:
- 框架
- 中间件
- redis
author: wspstart
comment: false
---


## 操作缓存和数据库的时候有三个问题需要考虑：

### 1、删除缓存还是更新缓存？
① 更新缓存的话，每次更新数据库都需要更新缓存，无效写操作操作。② 删除缓存的话，更新数据库时让缓存失效，查询时再更新缓存。结合两者的优缺点**，最优者为②**，减少无效的写操作。

### 2、 如何保证缓存与数据库的操作的同时成功和失败？
① 单体项目，将缓存与数据库操作放在一个事务中② 分布式系统，利用TCC等分布式事务方案

### 3、先操作缓存还是先操作数据库？
① 先删除缓存，再操作数据库② 先操作数据库，再删除缓存这两种操作上看似都是可以的，我们来深入探究一下到底是那种操作更胜一筹。**先操作缓存再操作数据库：**![image.png](https://raw.githubusercontent.com/zrgzs/images/main/images/20230907220548.jpg)假如：两个线程并行的对数据进行操作，线程1先删除缓存，后立即更新了数据库，使得V变为20，这时线程2才进行查询操作，发现缓存没有命中，这时会进行查询数据库，并将查询到的信息写入到Redis缓存中。这样的操作是合理的。但是如果是这种情况呢？![image.png](https://raw.githubusercontent.com/zrgzs/images/main/images/20230907220550.jpg)还是两个线程并行，线程1先删除了缓存，因为删除缓存的速度一般是微秒级别的，并更新数据库，因为写的操作数据库的速度要远大于操作Redis的速度，这时线程2开始了操作并查询了缓存，发现缓存不存在然后就去查询数据库，后写入缓存中。导致缓存中的数据是V=10,而这时线程1接着继续操作数据库并更新了V=20,这时就会导致缓存中的数据和数据库中的数据不一致。这种情况下，写入缓存的速度要远快于更新数据库的速度，所以这种情况发生的概率比较大。

**先操作数据库，再删除缓存**![image.png](https://raw.githubusercontent.com/zrgzs/images/main/images/20230907220553.jpg)线程1、线程2并行执行，线程2先操作了数据库，将V变为20，然后将缓存清空。这时线程1执行查询操作，没有命中就从数据库中获取数据，后写入到Redis中。这种情况下是看似是可行的。我们接着看下面这种情况：![image.png](https://raw.githubusercontent.com/zrgzs/images/main/images/20230907220556.jpg)同样线程1和线程2并行执行，线程1先查询缓存，没有命中就去数据库中获取数据，这时线程2更新了数据库使得V=20,然后将缓存清空，这时线程1继续执行将获取到的信息再写入到Redis中，这时缓存的数据为线程1获取到的旧数据，这时缓存和数据库中的信息是不一致的。但是在写如缓存中的速度要远快于更新数据库的速度，并且线程2还对缓存进行了删除。所以这种情况的发送的改了较先删除缓存，再操作数据库发送的概率要低的多。**总结：这两种方案都有可能出现数据的不一致性。最终我们选择先操作数据库后操作缓存作为我们的最佳实战策略。**
